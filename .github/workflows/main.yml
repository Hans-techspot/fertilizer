name: "🔀 Gemini Dispatch"

on:
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened]
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

jobs:
  codestral_analysis:
    runs-on: ubuntu-latest
    env:
      CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
    steps:
      - name: 🧰 Checkout Repository
        uses: actions/checkout@v4

      - name: ⚙️ Configure Codestral
        run: |
          mkdir -p ~/.config/opencode
          cat <<'EOF' > ~/.config/opencode/config.yaml
          providers:
            codestral:
              name: "Codestral"
              module: "@ai-sdk/openai-compatible"
              options:
                baseURL: "https://codestral.mistral.ai/v1"
                apiKey: ${{ secrets.CODESTRAL_API_KEY }}
              models:
                codestral-2501:
                  id: "codestral-2501"
                  name: "Codestral Primary Agent"
                codestral-latest:
                  id: "codestral-latest"
                  name: "Codestral Fallback Agent"
          defaultModel: "codestral/codestral-2501"
          EOF

          echo "✅ Configuration complete"
          echo "Config preview:"
          cat ~/.config/opencode/config.yaml

      - name: 🧪 Run Codestral Primary Model
        id: codestral_primary
        continue-on-error: true
        run: |
          echo "🚀 Running Codestral Primary (codestral-2501)..."
          opencode run --verbose -m codestral/codestral-2501 "Analyze and improve the recent code changes"

      - name: 🔁 Fallback to Codestral Latest
        if: steps.codestral_primary.outcome != 'success'
        run: |
          echo "⚠️ Primary model failed, switching to fallback model..."
          opencode run --verbose -m codestral/codestral-latest "Analyze and improve the recent code changes"

      - name: 📊 Workflow Summary
        if: always()
        run: |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║              📊 WORKFLOW EXECUTION REPORT                    ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "✅ Task: feature"
          echo "🌿 Branch: ${{ github.ref_name }}"
          echo "📅 Completed: $(date)"
          echo "👤 Requested by: ${{ github.actor }}"
          echo "🔗 Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
