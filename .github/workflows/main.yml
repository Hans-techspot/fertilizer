name: "ğŸ”€ Gemini Dispatch"

on:
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened]
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

jobs:
  codestral_analysis:
    runs-on: ubuntu-latest
    env:
      CODESTRAL_API_KEY: ${{ secrets.CODESTRAL_API_KEY }}
    steps:
      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure Codestral
        run: |
          mkdir -p ~/.config/opencode
          cat <<'EOF' > ~/.config/opencode/config.yaml
          providers:
            codestral:
              name: "Codestral"
              module: "@ai-sdk/openai-compatible"
              options:
                baseURL: "https://codestral.mistral.ai/v1"
                apiKey: ${{ secrets.CODESTRAL_API_KEY }}
              models:
                codestral-2501:
                  id: "codestral-2501"
                  name: "Codestral Primary Agent"
                codestral-latest:
                  id: "codestral-latest"
                  name: "Codestral Fallback Agent"
          defaultModel: "codestral/codestral-2501"
          EOF

          echo "âœ… Configuration complete"
          echo "Config preview:"
          cat ~/.config/opencode/config.yaml

      - name: ğŸ§ª Run Codestral Primary Model
        id: codestral_primary
        continue-on-error: true
        run: |
          echo "ğŸš€ Running Codestral Primary (codestral-2501)..."
          opencode run --verbose -m codestral/codestral-2501 "Analyze and improve the recent code changes"

      - name: ğŸ” Fallback to Codestral Latest
        if: steps.codestral_primary.outcome != 'success'
        run: |
          echo "âš ï¸ Primary model failed, switching to fallback model..."
          opencode run --verbose -m codestral/codestral-latest "Analyze and improve the recent code changes"

      - name: ğŸ“Š Workflow Summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ğŸ“Š WORKFLOW EXECUTION REPORT                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Task: feature"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“… Completed: $(date)"
          echo "ğŸ‘¤ Requested by: ${{ github.actor }}"
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
