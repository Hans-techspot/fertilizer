name: 'ðŸ¤– Codestral Dispatch'

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, reopened, synchronize]
  issue_comment:
    types: [created]

jobs:
  codestral:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§± Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure Codestral Provider
        run: |
          echo "âš™ï¸ Setting up Codestral configuration..."
          mkdir -p ~/.opencode
          cat > ~/.opencode/config.yaml << 'EOF'
          providers:
            codestral:
              name: "Codestral"
              module: "@ai-sdk/openai-compatible"
              options:
                baseURL: "https://codestral.mistral.ai/v1"
                apiKey: "DXfXAjwNIZcAv1ESKtoDwWZZF98lJxho"
              models:
                codestral-2501:
                  id: "codestral-2501"
                  name: "Codestral Primary Agent"
                  description: "Primary Codestral model for automated reasoning"
                  provider: "codestral"
                codestral-latest:
                  id: "codestral-latest"
                  name: "Codestral Fallback Agent"
                  description: "Backup model in case primary fails"
                  provider: "codestral"
          defaultModel: "codestral/codestral-2501"
          EOF
          echo "âœ… Codestral configuration completed."
          echo "ðŸ” Config preview:"
          cat ~/.opencode/config.yaml

      - name: ðŸ§  Run Codestral Task
        env:
          PRIMARY_MODEL: "codestral/codestral-2501"
          FALLBACK_MODEL: "codestral/codestral-latest"
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"
          echo "ðŸš€ Running primary model: $PRIMARY_MODEL"
          if ! opencode run -m "$PRIMARY_MODEL" "Analyze and improve recent commit"; then
            echo "âš ï¸ Primary model failed, retrying with fallback model ($FALLBACK_MODEL)..."
            if ! opencode run -m "$FALLBACK_MODEL" "Analyze and improve recent commit"; then
              echo "âŒ Both models failed â€” printing recent Codestral logs:"
              find ~/.local/share/opencode/log -type f -name "*.log" -print -exec cat {} \;
              exit 1
            fi
          fi

      - name: ðŸ“Š Workflow Summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ðŸ“Š WORKFLOW EXECUTION REPORT                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Task: Codestral dispatch complete"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ“… Completed: $(date)"
          echo "ðŸ‘¤ Requested by: ${{ github.actor }}"
          echo "ðŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
