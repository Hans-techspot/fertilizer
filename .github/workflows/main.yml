name: "âš™ï¸ Manual Task Runner (Codestral Agent)"

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: "ğŸ“ Task Description (What do you want the agent to do?)"
        required: true
        type: string
      task_type:
        description: "ğŸ·ï¸ Task Type"
        required: true
        type: choice
        options:
          - "bug-fix"
          - "feature"
          - "refactor"
          - "documentation"
          - "testing"
          - "optimization"
          - "other"
        default: "feature"
      branch_name:
        description: "ğŸŒ¿ Custom Branch Name (leave empty for auto-generated)"
        required: false
        type: string
      create_pr:
        description: "ğŸ“¤ Create Pull Request?"
        required: true
        type: boolean
        default: true
      pr_draft:
        description: "ğŸ“‹ Create as Draft PR?"
        required: true
        type: boolean
        default: true
      run_tests:
        description: "ğŸ§ª Run Tests Before Creating PR?"
        required: true
        type: boolean
        default: true
      target_branch:
        description: "ğŸ¯ Target Branch for PR"
        required: false
        type: string
        default: "main"
      additional_context:
        description: "ğŸ’¡ Additional Context/Instructions (optional)"
        required: false
        type: string

jobs:
  execute-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read

    env:
      PRIMARY_MODEL: "codestral-2501"
      FALLBACK_MODEL: "codestral-latest"
      DEFAULT_API_KEY: "DXfXAjwNIZcAv1ESKtoDwWZZF98lJxho"

    steps:
      - name: ğŸ“Š Display Task Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ğŸ¤– CODESRAL MANUAL TASK RUNNER                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Task Type: ${{ github.event.inputs.task_type }}"
          echo "ğŸ¯ Target Branch: ${{ github.event.inputs.target_branch }}"
          echo "ğŸ“¤ Create PR: ${{ github.event.inputs.create_pr }}"
          echo "ğŸ“‹ Draft PR: ${{ github.event.inputs.pr_draft }}"
          echo "ğŸ§ª Run Tests: ${{ github.event.inputs.run_tests }}"
          echo ""
          echo "ğŸ“„ Task Description:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "${{ github.event.inputs.task_description }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.target_branch }}

      - name: ğŸ”§ Set Up Git Identity
        run: |
          git config user.name "Codestral Agent[bot]"
          git config user.email "codestral-agent[bot]@users.noreply.github.com"

      - name: ğŸ“¦ Install OpenCode CLI
        run: |
          echo "ğŸ“¦ Installing OpenCode CLI..."
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          echo "âœ… OpenCode installed successfully"

      - name: âš™ï¸ Configure Codestral
        run: |
          echo "âš™ï¸ Setting up Codestral configuration..."
          mkdir -p ~/.opencode
          API_KEY="${{ secrets.CODESTRAL_API_KEY || env.DEFAULT_API_KEY }}"

          cat > ~/.opencode/config.yaml << EOF
          providers:
            codestral:
              name: "Codestral"
              module: "@ai-sdk/openai-compatible"
              options:
                baseURL: "https://codestral.mistral.ai/v1"
                apiKey: "${API_KEY}"
              models:
                ${PRIMARY_MODEL}:
                  id: "${PRIMARY_MODEL}"
                  name: "Codestral Primary Agent"
                ${FALLBACK_MODEL}:
                  id: "${FALLBACK_MODEL}"
                  name: "Codestral Fallback Agent"
          defaultModel: "codestral/${PRIMARY_MODEL}"
          EOF

          echo "âœ… Codestral configuration complete."
          echo "Config preview:"
          cat ~/.opencode/config.yaml | sed 's/apiKey: .*/apiKey: [REDACTED]/'

      - name: ğŸ” Generate Branch Name
        id: branch_name
        run: |
          if [ -n "${{ github.event.inputs.branch_name }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            TASK_TYPE="${{ github.event.inputs.task_type }}"
            SLUG=$(echo "${{ github.event.inputs.task_description }}" | head -c 30 | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]' '-' | sed 's/-$//')
            BRANCH_NAME="codestral/${TASK_TYPE}/${SLUG}-${TIMESTAMP}"
          fi
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "ğŸŒ¿ Branch name generated: ${BRANCH_NAME}"

      - name: ğŸ¤– Execute Task via Codestral Agent
        id: codestral_task
        continue-on-error: true
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"

          echo "=== Diagnostics ==="
          opencode --version || echo "âš ï¸ Failed to get OpenCode version"
          echo ""

          echo "ğŸš€ Running primary model: ${PRIMARY_MODEL}"
          opencode run --verbose -m codestral/${PRIMARY_MODEL} "Task: ${{ github.event.inputs.task_description }}"

      - name: ğŸ” Fallback to Codestral Latest
        if: steps.codestral_task.outcome != 'success'
        run: |
          echo "âš ï¸ Primary model failed, retrying with fallback model (${FALLBACK_MODEL})..."
          opencode run --verbose -m codestral/${FALLBACK_MODEL} "Task: ${{ github.event.inputs.task_description }}"

      - name: ğŸ“Š Generate Execution Report
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ğŸ“Š WORKFLOW EXECUTION REPORT                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Task: ${{ github.event.inputs.task_type }}"
          echo "ğŸŒ¿ Branch: ${{ steps.branch_name.outputs.branch_name }}"
          echo "ğŸ“… Completed: $(date)"
          echo "ğŸ‘¤ Requested by: ${{ github.actor }}"
          echo ""
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ TASK COMPLETED SUCCESSFULLY!"
          echo "ğŸŒ¿ Branch Created: ${{ steps.branch_name.outputs.branch_name }}"

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "âš ï¸ TASK FAILED"
          echo "Please review the logs above for details."
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
